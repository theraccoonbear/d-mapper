<!doctype html>
<!-- paulirish.com/2008/conditional-stylesheets-vs-css-hacks-answer-neither/ -->
<!--[if lt IE 7]> <html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if IE 7]>    <html class="no-js lt-ie9 lt-ie8" lang="en"> <![endif]-->
<!--[if IE 8]>    <html class="no-js lt-ie9" lang="en"> <![endif]-->
<!-- Consider adding a manifest.appcache: h5bp.com/d/Offline -->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"> <!--<![endif]-->
<head>
  <meta charset="utf-8">

  <title>Title</title>
  <meta name="description" content="">

  <!-- Mobile viewport optimized: h5bp.com/viewport -->
  <meta name="viewport" content="width=device-width">

  <!-- Place favicon.ico and apple-touch-icon.png in the root directory: mathiasbynens.be/notes/touch-icons -->

  <link rel="stylesheet" href="css/style.css">
	<link rel="stylesheet" href="css/d-mapper.css">
	
	<!-- Uncomment for Kalendae -->
	<!-- <link rel="stylesheet" href="css/kalendae.css"> -->
  <!-- More ideas for your <head> here: h5bp.com/d/head-Tips -->

  <!-- All JavaScript at the bottom, except this Modernizr build.
       Modernizr enables HTML5 elements & feature detects for optimal performance.
       Create your own custom Modernizr build: www.modernizr.com/download/ -->
  <script src="js/libs/modernizr-2.5.3.min.js"></script>
</head>
<body>
  <!-- Prompt IE 6 users to install Chrome Frame. Remove this if you support IE 6.
       chromium.org/developers/how-tos/chrome-frame-getting-started -->
  <!--[if lt IE 7]><p class=chromeframe>Your browser is <em>ancient!</em> <a href="http://browsehappy.com/">Upgrade to a different browser</a> or <a href="http://www.google.com/chromeframe/?redirect=true">install Google Chrome Frame</a> to experience this site.</p><![endif]-->
  
	
	<header>
		
	</header>
	
	
	
  <div role="main">
    <div id="sandbox">
			<div id="mapArea">
				<div id="cursorSnap" class="muie"><div id="activeSquare"></div></div>
				<div id="pointSet" class="muie"></div>
				<div id="marquee" class="muie"></div>
				<!--<div class="mapRoom" data-layout="0,0-100,75"></div>
				<div class="mapRoom" data-layout="5,8-2,5"></div>-->
			</div>

			<div id="workspace" class="col">
				<div id="baseLayer" class="layer"></div>
				<div id="overlayLayer" class="layer"></div>
			</div>
			<div id="controls" class="col">
				<div class="formContainer">
					<strong>Cursor:</strong> <span id="cursorPos">0, 0</span><br/>
				</div>
				
				<div class="formContainer">
					<label for="map-name">Map Name: <input type="text" id="map-name"></label><br/>
					<input class="mapAction" type="button" value="Save Map (local)" data-action="save"><br/>
					<input class="mapAction" type="button" value="Load Map (local)" data-action="load">
				</div>
				
				<div class="formContainer">
					<form id="addThings">
						<label for="room-x">Top Left Corner X: <input id="room-x" class="integer"></label><br/>
						<label for="room-y">Top Left Corner Y: <input id="room-y" class="integer"></label><br/>
						<label for="room-w">Width: <input id="room-w" class="integer"></label><br/>
						<label for="room-h">Height: <input id="room-h" class="integer"></label><br/>
						<input class="mapAction" type="button" value="Add Room" data-action="room"><br/>
						<input class="mapAction" type="button" value="Add Horiz. Door" data-action="hdoor"><br/>
						<input class="mapAction" type="button" value="Add Vert. Door" data-action="vdoor"><br/>
					</form>
				</div>
				
				
			</div>
			
		</div>
  </div>
  <footer>

  </footer>


  <!-- JavaScript at the bottom for fast page loading -->

  <!-- Grab Google CDN's jQuery, with a protocol relative URL; fall back to local if offline -->
  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
  <script>window.jQuery || document.write('<script src="js/libs/jquery-1.7.1.min.js"><\/script>')</script>
	<!-- scripts concatenated and minified via build script -->
  <script src="js/plugins.js"></script>
	<script src="js/raphael-min.js"></script>
	<script src="js/mapper.js"></script>
	<script type="text/javascript">
		
		var layout_rgx = new RegExp(/^\s*?(\d+)\s*?,\s*?(\d+)\s*?-\s*?(\d+)\s*?,\s*?(\d+)\s*?$/);
		
		$(function() {
			// begin raphael
			
			mapper.init();
			//mapper.drawRectRoom({x:3, y:7, w:10, h:5})
			//mapper.drawRoundRoom({x: 25, y: 10, r: 5});
			//mapper.drawRectRoom({x: 13, y: 9, w: 10, h: 1});
			//mapper.drawDoor({x: 13, y: 9, orient: mapper.VERT});
		
			
			// end raphael
			var $cursor = $('#cursorSnap');
			var $point = $('#pointSet');
			var $marquee = $('#marquee');
			var button_down = false;
			var init_x = 0;
			var init_y = 0;
			
			var $room_x = $('#room-x');
			var $room_y = $('#room-y');
			var $room_w = $('#room-w');
			var $room_h = $('#room-h');
			
			var int_rgx = new RegExp(/^\d+$/);
			
			var addRoom = function() {
				var x = $room_x.val();
				var y = $room_y.val();
				var w = $room_w.val();
				var h = $room_h.val();
				
				if (int_rgx.test(x)) {
					$room_x.removeClass('error');
				} else {
					$room_x.addClass('error');
					return false;
				}
				
				if (int_rgx.test(y)) {
					$room_y.removeClass('error');
				} else {
					$room_y.addClass('error');
					return false;
				}
				
				if (int_rgx.test(w)) {
					$room_w.removeClass('error');
				} else {
					$room_w.addClass('error');
					return false;
				}
				
				if (int_rgx.test(h)) {
					$room_h.removeClass('error');
				} else {
					$room_h.addClass('error');
					return false;
				}
				
				mapper.drawRectRoom({'x': x, 'y': y, 'w': w, 'h': h});
				
				return true;
			};
			
			var addDoor = function(orient) {
				var x = $room_x.val();
				var y = $room_y.val();
				
				if (int_rgx.test(x)) {
					$room_x.removeClass('error');
				} else {
					$room_x.addClass('error');
					return false;
				}
				
				if (int_rgx.test(y)) {
					$room_y.removeClass('error');
				} else {
					$room_y.addClass('error');
					return false;
				}
				
				mapper.drawDoor({'x': x, 'y': y, 'orient': orient});
				return true;
			};
			
			var saveMap = function() {
				var mapName = $('#map-name').val();
				if (mapper.saveLocal({name: mapName})) {
					$('#map-name').removeClass('error');
				} else {
					$('#map-name').addClass('error');
				}
				//if (/^[A-Za-z0-9-]+$/.test(mapName)) {
				//	$('#map-name').removeClass('error');
				//	if (typeof localStorage['d-mapper'] === 'undefined') { localStorage['d-mapper'] = '{}'; }
				//	
				//	var cs = false;
				//	try {
				//		cs = JSON.parse(localStorage['d-mapper']);
				//	} catch (e) {
				//		cs = false;
				//	}
				//	
				//	if (cs === false) { cs = {}; }
				//	
				//	if (typeof cs.maps === 'undefined') { cs.maps = {}; }
				//	cs.maps[mapName] = mapper.data; //.serialize();
				//	localStorage['d-mapper'] = JSON.stringify(cs);
				//	//localStorage['d-mapper']['maps'] = mapper;
				//	return true;
				//} else {
				//	$('#map-name').addClass('error');
				//	return false;
				//}
			};
			
			var loadMap = function() {
				var mapName = $('#map-name').val();
				if (mapper.loadLocal({name: mapName})) {
					$('#map-name').removeClass('error');
				} else {
					$('#map-name').addClass('error');
				}
			};
			
			$('#addThings').submit(function(e) {
				if (e.preventDefault) { e.preventDefault(); }
				return false;
			});
			
			$('.mapAction').click(function(e) {
				var $this = $(this);
				var action = $this.data('action');
				var ret = true;
				
				if (action == 'room') {
					ret = addRoom();
				} else if (action == 'hdoor') {
					ret = addDoor(mapper.HORIZ);
				} else if (action == 'vdoor') {
					ret = addDoor(mapper.VERT);
				} else if (action == 'save') {
					ret = saveMap();
				} else if (action == 'load') {
					ret = loadMap();
				} else {
					console.log("Unknown action: " + action);
				}
				
				if (ret) {
					$room_x.val('');
					$room_y.val('');
					$room_w.val('');
					$room_h.val('');
					$point.hide();
					$marquee.hide();
				}
					
				if (e.preventDefault) { e.preventDefault(); }
				return false;
			});
		
			$('.mapRoom').each(function() {
				var $this = $(this);
				var raw_layout = $this.data('layout');
				
				if (layout_rgx.test(raw_layout)) {
					var matches = layout_rgx.exec(raw_layout);
					var x = (parseInt(matches[1]) * 16);
					var y = (parseInt(matches[2]) * 16);
					var w = parseInt(matches[3]) * 16;
					var h = parseInt(matches[4]) * 16;
					
					$this.css({
						'left': x + 'px',
						'top': y + 'px',
						'width': w + 'px',
						'height': h + 'px'
					}).fadeIn(1000);
				}
			}); // setup rooms
			
			$('#mapArea, .mapRoom').mousemove(function(e) {
				//console.log(e);
				var real_x = e.clientX;
				var real_y = e.clientY;
				
				$('#cursorPos').html(Math.round(real_x / mapper.gridSize) + ', ' + Math.round(real_y / mapper.gridSize));
				
				var snap_x = mapper.snapPixel(real_x); //(Math.round(real_x / mapper.gridSize) * mapper.gridSize);
				var snap_y = (Math.round(real_y / mapper.gridSize) * mapper.gridSize);
				$cursor.css({left: snap_x - 1, top: snap_y - 1});
				
				if (button_down) {
					var cur_x = mapper.snapPixel(e.clientX);
					var cur_y = mapper.snapPixel(e.clientY);
					
					var x1 = Math.min(init_x, cur_x);
					var y1 = Math.min(init_y, cur_y);
					var x2 = Math.max(init_x, cur_x);
					var y2 = Math.max(init_y, cur_y);
					
					var w = x2 - x1;
					var h = y2 - y1;
					
					$room_x.val(mapper.pixelToGrid(x1));
					$room_y.val(mapper.pixelToGrid(y1));
					$room_w.val(mapper.pixelToGrid(w));
					$room_h.val(mapper.pixelToGrid(h));
					
					$marquee.css({'left': x1, 'top': y1, 'width': w + 'px','height': h + 'px'}).show();
				}
				
			}).mousedown(function(e) {
				button_down = true;
				
				var x = mapper.pixelToGrid(e.clientX);
				var y = mapper.pixelToGrid(e.clientY);
				
				$point.css({left: mapper.snapPixel(e.clientX) - 1, top: mapper.snapPixel(e.clientY) - 1}).show();
				
				$room_x.val(x);
				$room_y.val(y);
				
				init_x = mapper.snapPixel(e.clientX);
				init_y = mapper.snapPixel(e.clientY);
				$marquee.css({'left': init_x, 'top': init_y, 'width':'1px','height':'1px'}).show();
				
			}).mouseup(function(e) {
				button_down = false;
			});
			
		});
	</script>
	
	<!-- Uncomment for jQuery UI -->
  <!--<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.7.2/jquery-ui.min.js"></script>-->
  
	<!-- Uncomment for Kalendae -->
	<!--<script src="js/libs/kalendae.min.js" type="text/javascript" charset="utf-8"></script>-->
	
	<!-- Uncomment for dateFormat -->
	<!--<script src="js/libs/dateFormat.js" type="text/javascript"></script>-->
	
  <!-- end scripts -->

  <!-- Asynchronous Google Analytics snippet. Change UA-XXXXX-X to be your site's ID.
       mathiasbynens.be/notes/async-analytics-snippet -->
  <script>
    var _gaq=[['_setAccount','UA-XXXXX-X'],['_trackPageview']];
    (function(d,t){var g=d.createElement(t),s=d.getElementsByTagName(t)[0];
    g.src=('https:'==location.protocol?'//ssl':'//www')+'.google-analytics.com/ga.js';
    s.parentNode.insertBefore(g,s)}(document,'script'));
  </script>
</body>
</html>